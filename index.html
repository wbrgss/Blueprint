<!DOCTYPE html>
<html>
  <head>
    <title>BluePrint</title>
    <!-- Latest compiled and minified CSS -->

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/application.css">
    <link rel="stylesheet" href="css/bootstrap-select.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/tipsy.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.4.17/dagre-d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.min.js"></script>


    <script src="js/application.js"></script>
    <script src="js/bootstrap-select.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/tipsy.js"></script>
  </head>

  <body>
    <div class="envelope">
 				
 			<form style="width: 53; position: fixed; top:10px; left:10px; background-color: #2C5197;">
				  <fieldset>
				    <legend class="legend">Legend</legend>

				    <div class="pull-left">
					    <p>Course Level</p>
					    <div class="ledge"><div class="level" id="legend-100">100</div></div> 
					    <div class="ledge"><div class="level" id="legend-200">200</div></div> <br>
					    <div class="ledge"><div class="level" id="legend-300">300</div></div> 
					    <div class="ledge"><div class="level" id="legend-400">400</div></div>
					    <div class="ledge"><div class="level" id="legend-500">500</div></div>
				    </div>

				    <div class="pull-right">
						<p>Student Status</p>
					    <div class="ledge"><div class="g"><div>&nbsp;Taken (F-A)&nbsp;</div></div></div> <br>
					    <div class="ledge"><div class="untaken"><div>&nbsp;&nbsp;&nbsp;Untaken&nbsp;&nbsp;&nbsp;&nbsp;</div></div></div>
				    </div>
				  </fieldset>
			</form>

        	<div class="graph" style="width: 100%; height: 100%">

				<br>
				
<!-- 				<select class="selectpicker majors" data-live-search="true">
					<option selected="selected">Bachelor of Science (B.Sc.) - Major Computer Science (63 credits)</option>
				</select>

				<select class="selectpicker ranks">
					<option selected="selected">tight-tree</option>
					<option>longest-path</option>
					<option>network-simplex</option>
				</select> -->
				

			    <style id="css">

					body {
					  font: 300 14px 'Helvetica Neue', Helvetica;
					}
					.node rect {
					  stroke: #fff;
					  fill: #fff;
					  stroke-width: 4px;
					}
					g.l-100 > rect {
					  fill: #FFBC67;
					}
					g.l-200 > rect {
					  fill: #DA727E;
					}
					g.l-300 > rect {
					  fill: #AC6C82;
					}
					g.l-400 > rect {
					  fill: #685C79;
					}
					g.l-500 > rect {
					  fill: #455C7B;
					}
					g.taken-A > rect {
						stroke: #00cc66;
					}
					g.taken-Aminus > rect {
						stroke: #00e673;
					}
					g.taken-Bplus > rect {
						stroke: #00ff80;
					}
					g.taken-B > rect {
						stroke: #1aff8c;
					}
					g.taken-Bminus > rect {
						stroke: #33ff99;
					}
					g.taken-Cplus > rect {
						stroke: #66ffb3;
					}
					g.taken-C > rect {
						stroke: #80ffbf;
					}
					g.taken-D > rect {
						stroke: #b3ffd9;
					}
					g.taken-F > rect {
						stroke: #ff0000; 
					}
					.edgePath path {
					  stroke: #333;
					  fill: #333;
					  stroke-width: 2px;
					}
					.edgePath.l-100 path {
					  stroke: #FFBC67;
					}
					.edgePath.l-200 path {
					  stroke: #DA727E;
					}
					.edgePath.l-300 path {
					  stroke: #AC6C82;
					}
					.edgePath.l-400 path {
					  stroke: #685C79;
					}
					.edgePath.l-500 path {
					  stroke: #455C7B;
					}
					.l-100 > defs > marker > path {
					  fill: #FFBC67;
					}
					.l-200 > defs > marker > path {
					  fill: #DA727E;
					}
					.l-300 > defs > marker > path {
					  fill: #AC6C82;
					}
					.l-400 > defs > marker > path {
					  fill: #685C79;
					}
					.l-500 > defs > marker > path {
					  fill: #455C7B;
					}
					.node a {
					    color: black;
					    text-decoration: none;
					    font-weight: normal;
					}

			fieldset {
			    display: block;
			    -webkit-margin-start: 2px;
			    -webkit-margin-end: 2px;
			    -webkit-padding-before: 0.35em;
			    -webkit-padding-start: 0.75em;
			    -webkit-padding-end: 0.75em;
			    -webkit-padding-after: 0.625em;
			    min-width: -webkit-min-content;
			    border-width: 4px;
			    border-style: solid;
			    border-color: white;
			    border-image: initial;
			    font-family: helvetica;
    font-weight: 300;
    color: white;
			}

			legend {
			    display: block;
			    -webkit-padding-start: 2px;
			    -webkit-padding-end: 2px;
			    border-width: initial;
			    border-style: none;
			    border-color: initial;
			    border-image: initial;
			    width: 0;
			    width: initial;
			    font-family: helvetica;
			    font-weight: 600;
			    color: white;
			    margin-bottom: 0px;
			}

			.level {
			  width: 75px;
			  height: 25px;
			  background: #DA727E;
			  display: inline-block;
			  vertical-align: middle;
			  -webkit-border-radius: 5px;
			  -moz-border-radius: 5px;
			  border-radius: 5px;
			      line-height: 27px;
    			text-align: center;
    			font-weight: 400;
    			margin-bottom:5px;
			}

			#legend-100 {
			  background: #FFBC67;
			}
			#legend-200 {
			  background: #DA727E;
			}
			#legend-300 {
			  background: #AC6C82;	  
			}
			#legend-400 {
			  background: #685C79;
			}
			#legend-500 {
			  background: #455C7B;	
		    }

			#fail {
			  width: 20px;
			  height: 20px;
			  background: #fff;
			  border: 2px solid #ff0000;
			  display: inline-block;
			  vertical-align: middle;
			  -webkit-border-radius: 5px;
			 -moz-border-radius: 5px;
			 border-radius: 5px; 
			}

			.node a {
			    color: white;
			    text-decoration: none;
			    font-weight: normal;
			}

			.ledge {
			  display: inline-block;
			  margin-right: 15px;
			  line-height: 20px;
			  margin-bottom: 10px;
			}

			.g {
			background-image: -webkit-linear-gradient(left, #ff0000, #b3ffd9, #80ffbf, #66ffb3, #33ff99, #1aff8c, #00ff80, #00e673, #00cc66); /* For Safari 5.1 to 6.0 */
			  background-image: -o-linear-gradient(right, #ff0000, #b3ffd9, #80ffbf, #66ffb3, #33ff99, #1aff8c, #00ff80, #00e673, #00cc66); /* For Opera 11.1 to 12.0 */
			  background-image: -moz-linear-gradient(right, #ff0000, #b3ffd9, #80ffbf, #66ffb3, #33ff99, #1aff8c, #00ff80, #00e673, #00cc66); /* For Firefox 3.6 to 15 */
			  background-image: linear-gradient(to right, #ff0000, #b3ffd9, #80ffbf, #66ffb3, #33ff99, #1aff8c, #00ff80, #00e673, #00cc66); /* Standard syntax */
			padding: 5px;
			-webkit-border-radius: 5px;
			 -moz-border-radius: 5px;
			 border-radius: 5px;
			 display: inline-block;
			}

			.g > div { background: #2C5197; 
			-webkit-border-radius: 3px;
			 -moz-border-radius: 3px;
			 border-radius: 3px;
			 font-size: 14px;
			}

			.untaken {
			  border: 4px solid #fff;
			padding: 1px;
			-webkit-border-radius: 5px;
			 -moz-border-radius: 5px;
			 border-radius: 5px;
			 display: inline-block;
			}

			.untaken > div { background: #2C5197; 
			-webkit-border-radius: 3px;
			 -moz-border-radius: 3px;
			 border-radius: 3px; 
			}

				</style>

			    <svg width="100%" height="70vh" style="padding: 4vh 0"><g/></svg>
			  
			    <script>

					
					//SETTINGS

					var API_KEY = "bM0m3C6DBipbAVWbd6EcBy9INiShTN_t";
					// we can make the db account read only
					// or just do this in rails


					var program = "Bachelor of Science (B.Sc.) - Major Computer Science (63 credits)"
					var courses = {};
					var coursesTaken = {};

					var rank = "tight-tree"

					function init() {

						getCourses(program);
						getPreqs(courses);
						drawGraph();

						zoomOut();

					}

					function newProgram() {

						zoomIn();

						init();

					}

					function newRank() {
						zoomIn();

						drawGraph();

						zoomOut();

					}


					function getCourses(program) {

						var query = "{\"programs\":{\"$in\":[\"" + program + "\"]}}"

						$.ajax({
							async: false,
							dataType: "json",
							url: "https://api.mlab.com/api/1/databases/bluetest/collections/courses3?q=" + query + "&apiKey=" + API_KEY,
							success: function(progCourses) {
								//singles = data;
								courses = progCourses;
							}
						});

							$.ajax({
								async: false,
								global: false,
								dataType: "json",
								url: "user_details/user-1.json",
								success: function(userCourses) {
									coursesTaken = userCourses;
								}
							});

					}


					function getPreqs(nodes) {

						var ids = $.map(nodes, function(val) { return val.preqs; });
						var uids = JSON.stringify(_.uniq(ids));

						var cids = _.map(courses, 'cid');
						var ucids = JSON.stringify(_.uniq(cids));

						if (_.isEmpty(nodes)) {
							return "done";
						}

						else {
							var ids = $.map(nodes, function(val) { return val.preqs; });
							var uids = JSON.stringify(_.uniq(ids));

							var cids = _.map(courses, 'cid');
							var ucids = JSON.stringify(_.uniq(cids));

							var query = "{ $and: [{\"cid\":{\"$in\":" + uids + "} }, {\"cid\":{\"$nin\":" + ucids + "}} ] }"

							$.ajax({
							async: false,
							dataType: "json",
							url: "https://api.mlab.com/api/1/databases/bluetest/collections/courses3?q=" + query + "&apiKey=" + API_KEY,
							success: function(preqs) {
							       //singles = data;
							       nodes = preqs;
							    }
							});

							courses = courses.concat(nodes);

							return getPreqs(nodes);

						}

					}

					function drawGraph() {

						// Create a new directed graph
						g = new dagreD3.graphlib.Graph()
							.setGraph({rankdir: 'LR', align: 'DL', nodesep: 25, ranksep: 150, ranker: rank})
							.setDefaultEdgeLabel(function() { return {}; });

						for(var k in courses) {
							if (courses[k] !== undefined) {
								console.log(courses[k]);
								//change the link to a url param return from scraper (i.e. add to scraper)

								var sclass = "l-" + courses[k].code.charAt(0) + "00";
								for(var t in coursesTaken) {
									if(courses[k].subject == coursesTaken[t].subject && courses[k].code == coursesTaken[t].code) {
										//console.log('course taken: ');
										//console.log(coursesTaken[t]);

										var grade = coursesTaken[t].grade;
										if( grade == 'A-' )
											grade = 'Aminus';
										else if(grade == 'B+')
											grade = 'Bplus';
										else if(grade == 'B-')
											grade = 'Bminus';
										else if(grade == 'C+')
											grade = 'Cplus';

										sclass +=  " taken-" + grade;
										break;
									}
								}

								g.setNode(courses[k].cid,  { label: "<a href=/courses/" + courses[k].subject + "-" + courses[k].code + " target=\"_blank\">" + courses[k].cid + "</a>", labelType: "html",class: sclass , rx: 5, ry: 5, title: courses[k].title, cid: courses[k].cid, terms: courses[k].terms, instructors: courses[k].instructors, credits: courses[k].credits });
							}
						}

						svg = d3.select("svg"),
						    inner = svg.select("g");

						// Set up edges, no special attributes.
						for(var k in courses) {
							if (courses[k].preqs.length !== 0) {
								//console.log(roots[k].preqs);
								for (var j in courses[k].preqs) {
									if (_.some(courses, ['cid', courses[k].preqs[j]])) {
										//console.log(courses[k].preqs[j]);
										//console.log(courses[k].cid + " requires " + courses[k].preqs[j]);
										g.setEdge(courses[k].preqs[j],courses[k].cid, { class:"l-" + courses[k].code.charAt(0) + "00"})
									}
									//g.setNode(roots[k].cid,  { label: roots[k].cid,        class: "type-NP" });
								}
							}
						}


						// Create the renderer
						var render = new dagreD3.render();

						// Run the renderer. This is what draws the final graph.
						render(inner, g);

						zoom = d3.behavior.zoom().on("zoom", function() {
							inner.attr("transform", "translate(" + d3.event.translate + ")" + "scale(" + d3.event.scale + ")");
						});
						svg.call(zoom);

						// Simple function to style the tooltip for the given node.
						var styleTooltip = function(title, cid, terms, instructors, credits) {
							return '<div class="popup"><p class="title">  <span>Title</span> : ' + title + '</p><p class="cid">  <span>Code</span> : ' + cid + '</p><p class="terms">  <span>Terms</span> : ' + terms + '</p><p class="instructors">  <span>Instructors</span> : ' + instructors + '</p><p class="credits">  <span>Credits</span> : ' + credits + '</p><div>';
						};

						inner.selectAll("g.node")
							.attr("title", function(v) { return styleTooltip(g.node(v).title, g.node(v).cid, g.node(v).terms, g.node(v).instructors, g.node(v).credits) })
							.each(function(v) { $(this).tipsy({ gravity: "w", opacity: 1, html: true }); });

					}

					function zoomIn () {
					  // Center the graph up
					  var initialScale = 1;
					  zoom
					    .translate([100, 20])
					    .scale(initialScale)
					    .event(svg);
					  svg.attr('height', g.graph().height * initialScale + 40);

					}

					function zoomOut () {

					  // Center the graph down
					  var initialScale = 1;
					  zoom
					    .translate([100, 20])
					    .scale(initialScale)
					    .event(svg);
					  svg.attr('height', g.graph().height * initialScale + 40);

					}

					$('.majors').on('change', function(event) {
						program = this.value;
						newProgram();
					});

					$('.ranks').on('change', function(event) {
						rank = this.value;
						newProgram();
					});

					init();

				</script>
			</div>
    </div>  

  </body>
</html>
